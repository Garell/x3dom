<!DOCTYPE html>
<html>
	<head>
	    <meta http-equiv='X-UA-Compatible' content='chrome=1'></meta>
	    <meta http-equiv='Content-Type' content='text/html;charset=utf-8'></meta>
		<script type="text/javascript" src="../../x3dom_include.js"></script>
		<script id="pbrFragShader" type="text/plain">
			precision mediump float;

			uniform samplerCube envTex;
			uniform sampler2D BRDF;
			
			varying vec3 v_texCoord;
			varying vec3 v_normal;
			varying vec3 v_eyeVector;
		
			float saturate(float x) {
				return clamp(x, 0.0, 1.0);
			}		
			
			vec3 fresnel_factor(vec3 f0, float product)
			{
				return mix(f0, vec3(1.0), pow(1.01 - product, 5.0));
			}
			
			void main()
			{
				vec2 texcoord = vec2(v_texCoord.x,-v_texCoord.y);
				
				float roughness = 0.0;
				float metalness = 1.0;
				vec3 baseColor = vec3(0.2, 0.4, 0.6);

				//vec3 normal = perturb_normal(v_normal, v_eyeVector, texcoord);

				vec3 N = normalize(v_normal);
				vec3 V = normalize(-v_eyeVector);

				float NoV = saturate(dot(N,V));    

				vec3 F0 = mix(vec3(0.04), baseColor, metalness);
				vec3 Fc = fresnel_factor(F0, NoV);

				vec3 cdiff = baseColor * (1.0 - Fc);

				vec3 R =  reflect(-V,N);

				vec3 EnvDiff = textureCube(envTex, R).xyz; 
				vec3 EnvSpec = textureCube(envTex, R).xyz; 
				vec2 EnvBRDF = texture2D(BRDF, vec2(roughness, NoV)).xy; 

				vec3 specular =  EnvSpec * (F0 * EnvBRDF.x + EnvBRDF.y);
				vec3 diff = EnvDiff * mix(cdiff, vec3(0.0), F0);

				vec3 color = diff + specular;

				gl_FragColor = vec4(color, 1.0);
				
				//gl_FragColor = vec4(texture2D(BRDF,texcoord).xyz, 1.0);
			}
		</script>
	</head>
	<body>
		<x3d id="x3d" style="width:100%;height:100%;">
			<scene>
				<shape>
					<Appearance>
						<PhysicalMaterial>
							<ComposedCubeMapTexture containerfield="envMap" >
								<ImageTexture url="posx.jpg" containerfield="right"></ImageTexture>
								<ImageTexture url="negx.jpg" containerfield="left"></ImageTexture>

								<ImageTexture url="posy.jpg" containerfield="top"></ImageTexture>
								<ImageTexture url="negy.jpg" containerfield="bottom"></ImageTexture>

								<ImageTexture url="posz.jpg" containerfield="front"></ImageTexture>
								<ImageTexture url="negz.jpg" containerfield="back"></ImageTexture>
							</ComposedCubeMapTexture>
						</PhysicalMaterial>
					</Appearance>
					<Sphere />
				</shape>				
			</scene>
		</x3d>
	</body>
</html>